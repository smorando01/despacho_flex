<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Despacho Flex & Colecta</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #050815;
      --panel: #0b1220;
      --panel-strong: #0f172a;
      --border: #111827;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.16);
      --accent-strong: rgba(34, 197, 94, 0.45);
    }

    body.courier-colecta {
      --accent: #a855f7;
      --accent-soft: rgba(168, 85, 247, 0.16);
      --accent-strong: rgba(168, 85, 247, 0.45);
    }

    * { box-sizing: border-box; }

    body {
      background: radial-gradient(circle at 20% 20%, rgba(59, 130, 246, 0.08), transparent 25%),
                  radial-gradient(circle at 80% 10%, rgba(168, 85, 247, 0.08), transparent 25%),
                  var(--bg);
      color: var(--text);
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      min-height: 100vh;
    }

    header {
      padding: 18px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(12px);
      background: rgba(5, 8, 21, 0.9);
    }

    header h1 { margin: 0; font-size: 20px; letter-spacing: .02em; }
    header .subtitle { font-size: 13px; color: var(--muted); margin-top: 4px; }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .tag {
      font-size: 12px;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid var(--accent-strong);
      background: var(--accent-soft);
      color: var(--text);
    }

    .link-button {
      font-size: 12px;
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text);
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .link-button:hover {
      border-color: var(--accent);
    }

    .container {
      padding: 18px 24px 32px;
      max-width: 1180px;
      margin: 0 auto;
    }

    .panels-grid {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px 18px;
    }

    .panel h2 {
      margin: 0 0 8px;
      font-size: 16px;
      letter-spacing: .01em;
    }

    .label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: var(--muted);
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 12px;
    }

    input, select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--panel-strong);
      color: var(--text);
      font-size: 14px;
      outline: none;
    }

    input:focus, select:focus {
      border-color: var(--accent);
    }

    button {
      cursor: pointer;
      border: none;
    }

    .primary-btn {
      width: 100%;
      padding: 12px 14px;
      border-radius: 10px;
      background: linear-gradient(120deg, var(--accent), var(--accent-strong));
      border: 1px solid var(--accent-strong);
      color: #0b101c;
      font-weight: 700;
      letter-spacing: .01em;
      transition: transform .1s ease, box-shadow .2s ease;
    }

    .primary-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 18px rgba(0,0,0,0.25);
    }

    .ghost-btn {
      padding: 9px 14px;
      border-radius: 999px;
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
      font-size: 13px;
    }

    .status-chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--accent-strong);
      background: var(--accent-soft);
      color: var(--text);
      font-size: 13px;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin: 12px 0 18px;
    }

    .metric-card {
      background: var(--panel);
      border-radius: 12px;
      padding: 12px 14px;
      border: 1px solid var(--border);
    }

    .metric-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .metric-value {
      font-size: 22px;
      font-weight: 700;
    }

    .metric-sub {
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
    }

    .scan-box {
      margin-bottom: 14px;
      padding: 14px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: var(--panel);
      display: grid;
      gap: 10px;
    }

    .scan-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .scan-row input {
      flex: 1 1 260px;
    }

    .pill-status {
      font-size: 12px;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--text);
      min-width: 120px;
      text-align: center;
    }

    .pill-status.ok {
      background: var(--accent-soft);
      border-color: var(--accent-strong);
    }

    .pill-status.invalid {
      background: rgba(250, 204, 21, 0.16);
      border-color: rgba(250, 204, 21, 0.45);
      color: #fef08a;
    }

    .pill-status.dup {
      background: rgba(249, 115, 22, 0.16);
      border-color: rgba(249, 115, 22, 0.45);
      color: #fed7aa;
    }

    .toolbar {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      font-size: 12px;
      margin: 12px 0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 13px;
    }

    th, td {
      padding: 8px 8px;
      border-bottom: 1px solid var(--border);
      text-align: left;
      white-space: nowrap;
    }

    th {
      font-weight: 600;
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .08em;
    }

    .pill {
      padding: 3px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--panel-strong);
      font-size: 11px;
      display: inline-block;
    }

    .pill-ok {
      border-color: var(--accent-strong);
      background: var(--accent-soft);
    }

    .pill-invalid {
      border-color: rgba(250, 204, 21, 0.5);
      background: rgba(250, 204, 21, 0.12);
      color: #fef3c7;
    }

    .action-button {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 6px 10px;
      font-size: 12px;
      color: var(--text);
      cursor: pointer;
    }

    .action-button:hover:enabled {
      border-color: var(--accent);
    }

    .hidden { display: none !important; }

    @media (max-width: 700px) {
      header { flex-direction: column; align-items: flex-start; gap: 8px; }
      .scan-row { flex-direction: column; align-items: stretch; }
      .scan-row input { width: 100%; }
    }
  </style>
</head>
<body class="courier-flex">

<header>
  <div>
    <h1>Despacho Flex &amp; Colecta</h1>
    <div class="subtitle">Flujo de despacho con inicio explícito</div>
  </div>
  <div class="header-actions">
    <div id="state-chip" class="tag">Sin sesión activa</div>
    <a class="link-button" href="historial.html">Historial de despachos &rarr;</a>
  </div>
</header>

<div class="container">
  <div class="panels-grid">
    <div id="start-panel" class="panel">
      <div class="label">Estado A — Iniciar despacho</div>
      <h2>Crear una nueva sesión</h2>
      <form id="start-form">
        <div class="input-group">
          <label class="label" for="courier">Tipo de despacho</label>
          <select id="courier" required>
            <option value="FLEX">Flex</option>
            <option value="COLECTA">Colecta</option>
          </select>
        </div>
        <div class="input-group">
          <label class="label" for="transportista">Empresa / Cadete</label>
          <input id="transportista" type="text" placeholder="Ej: Empresa de Transporte" required />
        </div>
        <div class="input-group">
          <label class="label" for="matricula">Matrícula</label>
          <input id="matricula" type="text" placeholder="ABC1234" required />
        </div>
        <button type="submit" class="primary-btn">Iniciar despacho</button>
      </form>
    </div>

    <div id="active-panel" class="panel hidden">
      <div class="label">Estado B — Sesión activa</div>
      <h2 id="session-title">Despacho activo</h2>
      <p id="session-subtitle" style="margin-top:4px; color: var(--muted); font-size: 13px;"></p>
      <div style="display:flex; gap:10px; flex-wrap:wrap; margin:12px 0;">
        <div class="status-chip" id="session-chip">—</div>
        <button id="btn-close" class="ghost-btn">Cerrar despacho</button>
      </div>
      <div style="font-size:12px; color:var(--muted); margin-top:8px;">
        El escáner sólo aceptará códigos válidos para el tipo seleccionado.
      </div>
    </div>
  </div>

  <div id="scan-panel" class="panel hidden" style="margin-top:14px;">
    <div class="metrics-grid">
      <div class="metric-card">
        <div class="metric-title">Total registrados</div>
        <div class="metric-value" id="metric-total">0</div>
        <div class="metric-sub">Incluye inválidos</div>
      </div>
      <div class="metric-card">
        <div class="metric-title" id="metric-ok-title">Códigos OK</div>
        <div class="metric-value" id="metric-ok">0</div>
        <div class="metric-sub" id="metric-ok-sub">Formato correcto</div>
      </div>
      <div class="metric-card">
        <div class="metric-title">Inválidos</div>
        <div class="metric-value" id="metric-invalid">0</div>
        <div class="metric-sub">Revisar formato</div>
      </div>
      <div class="metric-card">
        <div class="metric-title">Último estado</div>
        <div class="metric-value" id="metric-last-status">–</div>
        <div class="metric-sub" id="metric-last-code">Esperando primer escaneo</div>
      </div>
    </div>

    <div class="scan-box">
      <div class="scan-row">
        <input id="scan-input" type="text" autocomplete="off" placeholder="Apuntá el lector aquí y escaneá..." />
        <div id="scan-status-pill" class="pill-status">Listo</div>
      </div>
      <div style="font-size:12px; color:var(--muted);">Enter o fin de lectura = registrar código</div>
    </div>

    <div class="toolbar">
      <span>Búsqueda:</span>
      <input id="search-input" type="text" placeholder="Buscar por código..." style="max-width:220px;" />
      <span id="tipo-badge" class="pill" style="border-color: var(--accent); color: var(--text);">—</span>
    </div>

    <div style="overflow-x:auto; max-height: 60vh;">
      <table>
        <thead>
          <tr>
            <th>Hora</th>
            <th>Código</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="table-body"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
  const STORAGE_API_KEY = 'flex_districad_api_key';

  const scans = [];
  let sessionInfo = null;
  let metrics = { total: 0, ok: 0, invalidos: 0 };
  let lastScan = null;
  let csrfToken = '';
  let apiKey = localStorage.getItem(STORAGE_API_KEY) || '';

  const startPanel = document.getElementById('start-panel');
  const activePanel = document.getElementById('active-panel');
  const scanPanel = document.getElementById('scan-panel');
  const scanInput = document.getElementById('scan-input');
  const statusPill = document.getElementById('scan-status-pill');
  const tbody = document.getElementById('table-body');
  const searchInput = document.getElementById('search-input');
  const metricTotal = document.getElementById('metric-total');
  const metricOk = document.getElementById('metric-ok');
  const metricInvalid = document.getElementById('metric-invalid');
  const metricLastStatus = document.getElementById('metric-last-status');
  const metricLastCode = document.getElementById('metric-last-code');
  const metricOkTitle = document.getElementById('metric-ok-title');
  const metricOkSub = document.getElementById('metric-ok-sub');
  const tipoBadge = document.getElementById('tipo-badge');
  const sessionTitle = document.getElementById('session-title');
  const sessionSubtitle = document.getElementById('session-subtitle');
  const sessionChip = document.getElementById('session-chip');
  const stateChip = document.getElementById('state-chip');

  function clearStoredApiKey() {
    apiKey = '';
    localStorage.removeItem(STORAGE_API_KEY);
  }

  async function ensureApiKey() {
    apiKey = (apiKey || '').trim();

    while (!apiKey) {
      const input = window.prompt('Ingresá el token API proporcionado por sistemas:') || '';
      apiKey = input.trim();
      if (!apiKey) {
        const retry = window.confirm('Se necesita un token API para continuar. ¿Intentar nuevamente?');
        if (!retry) break;
      }
    }

    if (apiKey) {
      localStorage.setItem(STORAGE_API_KEY, apiKey);
    }

    return apiKey;
  }

  async function apiFetch(url, options = {}, extra = {}) {
    await ensureApiKey();
    if (!apiKey) throw new Error('No se ingresó un token API.');

    const opts = { credentials: 'same-origin', ...options };
    const headers = new Headers(opts.headers || {});

    if (opts.body && !headers.has('Content-Type')) {
      headers.set('Content-Type', 'application/json');
    }

    headers.set('X-Api-Key', apiKey);

    if (extra.requireCsrf) {
      if (!csrfToken) throw new Error('Token CSRF no inicializado. Recargá para sincronizar.');
      headers.set('X-CSRF-Token', csrfToken);
    }

    opts.headers = headers;

    const resp = await fetch(url, opts);

    if (resp.status === 401) {
      clearStoredApiKey();
      throw new Error('Token API inválido o expirado. Ingresá uno nuevo y reintentá.');
    }

    if (resp.status === 403 && extra.requireCsrf) {
      throw new Error('Token CSRF inválido. Recargá la página.');
    }

    return resp;
  }

  async function parseJsonResponse(resp) {
    const text = await resp.text();
    if (!text || !text.trim()) {
      throw new Error(`El servidor respondió ${resp.status} sin contenido.`);
    }
    try {
      return JSON.parse(text);
    } catch (error) {
      const snippet = text.slice(0, 200).replace(/\s+/g, ' ').trim();
      throw new Error(`Respuesta no válida del servidor (HTTP ${resp.status}). ${snippet || ''}`);
    }
  }

  function setAccentFromCourier(courier) {
    document.body.classList.remove('courier-flex', 'courier-colecta');
    if (courier === 'COLECTA') {
      document.body.classList.add('courier-colecta');
    } else {
      document.body.classList.add('courier-flex');
    }
  }

  function formatScan(scan) {
    const ts = scan.ts ? Number(scan.ts) : (scan.scanned_at ? new Date(scan.scanned_at).getTime() : Date.now());
    return {
      id: scan.id != null ? Number(scan.id) : null,
      codigo: scan.codigo,
      tipo: scan.tipo || (sessionInfo && sessionInfo.courier === 'COLECTA' ? 'Colecta' : 'Flex'),
      estado: scan.estado || 'OK',
      ts,
    };
  }

  function setStatusPill(estado) {
    statusPill.className = 'pill-status';
    if (estado === 'OK') {
      statusPill.classList.add('ok');
      statusPill.textContent = 'OK';
    } else if (estado === 'CÓDIGO INVÁLIDO') {
      statusPill.classList.add('invalid');
      statusPill.textContent = 'Inválido';
    } else if (estado === 'DUPLICADO') {
      statusPill.classList.add('dup');
      statusPill.textContent = 'Duplicado';
    } else if (estado) {
      statusPill.textContent = estado;
    } else {
      statusPill.textContent = 'Listo';
    }
  }

  function renderMetrics() {
    metricTotal.textContent = metrics.total || 0;
    metricOk.textContent = metrics.ok || 0;
    metricInvalid.textContent = metrics.invalidos || 0;
    if (sessionInfo) {
      const tipoUi = sessionInfo.courier === 'COLECTA' ? 'Colecta' : 'Flex';
      metricOkTitle.textContent = `${tipoUi} OK`;
      metricOkSub.textContent = `Formato válido de ${tipoUi}`;
      tipoBadge.textContent = `Despacho ${tipoUi}`;
      tipoBadge.style.borderColor = 'var(--accent)';
    } else {
      metricOkTitle.textContent = 'Códigos OK';
      metricOkSub.textContent = 'Formato correcto';
      tipoBadge.textContent = 'Sin sesión';
      tipoBadge.style.borderColor = 'var(--border)';
    }

    if (lastScan) {
      metricLastStatus.textContent = lastScan.estado;
      metricLastCode.textContent = lastScan.codigo;
    } else {
      metricLastStatus.textContent = '–';
      metricLastCode.textContent = 'Esperando primer escaneo';
    }
  }

  function renderTable() {
    const search = searchInput.value.trim();
    tbody.innerHTML = '';

    const filtrados = scans.filter(s => {
      if (search && !s.codigo.includes(search)) return false;
      return true;
    }).slice().reverse();

    for (const registro of filtrados) {
      const tr = document.createElement('tr');
      if (registro.estado === 'CÓDIGO INVÁLIDO') tr.style.background = 'rgba(250, 204, 21, 0.06)';

      const hora = new Date(registro.ts).toLocaleTimeString('es-UY', { hour12: false });

      const tdHora = document.createElement('td');
      tdHora.textContent = hora;

      const tdCodigo = document.createElement('td');
      tdCodigo.textContent = registro.codigo;

      const tdEstado = document.createElement('td');
      const estadoSpan = document.createElement('span');
      estadoSpan.className = 'pill ' + (registro.estado === 'OK' ? 'pill-ok' : 'pill-invalid');
      estadoSpan.textContent = registro.estado;
      tdEstado.appendChild(estadoSpan);

      const tdAccion = document.createElement('td');
      const btnEliminar = document.createElement('button');
      btnEliminar.type = 'button';
      btnEliminar.className = 'action-button';
      btnEliminar.textContent = 'Eliminar';
      btnEliminar.disabled = !registro.id;
      btnEliminar.addEventListener('click', () => {
        if (!registro.id) return;
        if (window.confirm(`¿Eliminar el código ${registro.codigo}?`)) {
          eliminarLectura(registro.id);
        }
      });
      tdAccion.appendChild(btnEliminar);

      tr.appendChild(tdHora);
      tr.appendChild(tdCodigo);
      tr.appendChild(tdEstado);
      tr.appendChild(tdAccion);
      tbody.appendChild(tr);
    }
  }

  function togglePanels() {
    if (sessionInfo) {
      startPanel.classList.add('hidden');
      activePanel.classList.remove('hidden');
      scanPanel.classList.remove('hidden');
      stateChip.textContent = 'Sesión activa';
    } else {
      startPanel.classList.remove('hidden');
      activePanel.classList.add('hidden');
      scanPanel.classList.add('hidden');
      stateChip.textContent = 'Sin sesión activa';
    }
  }

  function renderSessionInfo() {
    if (!sessionInfo) {
      setAccentFromCourier(null);
      sessionTitle.textContent = 'Despacho activo';
      sessionSubtitle.textContent = '';
      sessionChip.textContent = 'Sin sesión';
      return;
    }
    setAccentFromCourier(sessionInfo.courier);
    const tipoUi = sessionInfo.courier === 'COLECTA' ? 'Colecta' : 'Flex';
    sessionTitle.textContent = `Despacho ${tipoUi} #${sessionInfo.numero_en_dia}`;
    sessionSubtitle.textContent = `${sessionInfo.transportista} — ${sessionInfo.matricula}`;
    sessionChip.textContent = `${tipoUi} • Iniciado ${sessionInfo.started_at || sessionInfo.fecha}`;
  }

  async function sincronizarSesion() {
    try {
      const resp = await apiFetch('api/current_session.php');
      const data = await parseJsonResponse(resp);

      if (!data.success) throw new Error(data.message || 'No se pudo sincronizar.');
      if (data.csrf_token) csrfToken = data.csrf_token;

      sessionInfo = data.session;
      metrics = data.metrics || { total: 0, ok: 0, invalidos: 0 };
      scans.length = 0;
      lastScan = data.last_scan ? formatScan(data.last_scan) : null;

      if (Array.isArray(data.scans)) {
        data.scans.forEach(s => scans.push(formatScan(s)));
      }

      renderSessionInfo();
      renderMetrics();
      renderTable();
      togglePanels();

      if (sessionInfo) scanInput.focus();
    } catch (err) {
      console.error(err);
      alert(err.message || 'Error al sincronizar con el backend.');
    }
  }

  async function crearSesion(e) {
    e.preventDefault();
    const courier = document.getElementById('courier').value;
    const transportista = document.getElementById('transportista').value.trim();
    const matricula = document.getElementById('matricula').value.trim();

    if (!courier || !transportista || !matricula) {
      alert('Completá todos los campos para iniciar el despacho.');
      return;
    }

    try {
      const resp = await apiFetch('api/create_session.php', {
        method: 'POST',
        body: JSON.stringify({ courier, transportista, matricula })
      }, { requireCsrf: true });

      const data = await parseJsonResponse(resp);
      if (!data.success) throw new Error(data.message || 'No se pudo crear la sesión.');

      if (data.csrf_token) csrfToken = data.csrf_token;
      sessionInfo = data.session;
      metrics = { total: 0, ok: 0, invalidos: 0 };
      scans.length = 0;
      lastScan = null;

      renderSessionInfo();
      renderMetrics();
      renderTable();
      togglePanels();
      scanInput.focus();
      setStatusPill(null);
    } catch (err) {
      console.error(err);
      alert(err.message || 'Error al iniciar el despacho.');
    }
  }

  async function manejarScan(rawValue) {
    if (!sessionInfo) {
      alert('Iniciá un despacho antes de escanear.');
      return;
    }

    const raw = String(rawValue || '').trim();
    if (!raw) return;

    try {
      const resp = await apiFetch('api/scan.php', {
        method: 'POST',
        body: JSON.stringify({ raw })
      }, { requireCsrf: true });

      const data = await parseJsonResponse(resp);

      if (!data.success) {
        setStatusPill('ERROR');
        alert(data.message || 'Error procesando el código.');
        return;
      }

      if (data.csrf_token) csrfToken = data.csrf_token;

      metrics = data.metrics || metrics;
      const reg = data.registro;

      setStatusPill(reg.estado);

      if (reg.estado === 'DUPLICADO') {
        lastScan = formatScan({ ...reg, ts: reg.scanned_at });
      } else {
        const scan = formatScan({ ...reg, ts: reg.scanned_at });
        scans.push(scan);
        lastScan = scan;
      }

      renderMetrics();
      renderTable();
    } catch (err) {
      console.error(err);
      setStatusPill('ERROR');
      alert(err.message || 'Error de red o del servidor.');
    }
  }

  async function eliminarLectura(scanId) {
    if (!scanId) return;
    try {
      const resp = await apiFetch('api/delete_scan.php', {
        method: 'POST',
        body: JSON.stringify({ scan_id: scanId })
      }, { requireCsrf: true });

      const data = await parseJsonResponse(resp);
      if (!data.success) {
        alert(data.message || 'No se pudo eliminar la lectura.');
        return;
      }

      const idx = scans.findIndex(s => Number(s.id) === Number(scanId));
      if (idx !== -1) scans.splice(idx, 1);

      metrics = data.metrics || metrics;
      lastScan = data.last_scan ? formatScan(data.last_scan) : null;

      renderMetrics();
      renderTable();
    } catch (err) {
      console.error(err);
      alert(err.message || 'Error al eliminar la lectura.');
    }
  }

  async function cerrarSesion() {
    if (!sessionInfo) return;
    if (!confirm('¿Confirmar cierre del despacho actual?')) return;

    try {
      const resp = await apiFetch('api/close_session.php', {
        method: 'POST'
      }, { requireCsrf: true });

      const data = await parseJsonResponse(resp);
      if (!data.success) {
        alert(data.message || 'Error al cerrar el despacho.');
        return;
      }

      const m = data.metrics || {};
      alert(
        `Despacho cerrado.\n\n` +
        `Tipo: ${(sessionInfo.courier === 'COLECTA') ? 'Colecta' : 'Flex'}\n` +
        `Empresa: ${sessionInfo.transportista}\n` +
        `Matrícula: ${sessionInfo.matricula}\n` +
        `Despacho #: ${m.numero_en_dia || sessionInfo.numero_en_dia}\n` +
        `Paquetes: ${m.total || 0}\n` +
        `OK: ${m.ok || 0} | Inválidos: ${m.invalidos || 0}`
      );

      sessionInfo = null;
      metrics = { total: 0, ok: 0, invalidos: 0 };
      scans.length = 0;
      lastScan = null;
      setStatusPill(null);
      renderSessionInfo();
      renderMetrics();
      renderTable();
      togglePanels();
    } catch (err) {
      console.error(err);
      alert(err.message || 'Error de red al cerrar el despacho.');
    }
  }

  document.getElementById('start-form').addEventListener('submit', crearSesion);
  document.getElementById('btn-close').addEventListener('click', cerrarSesion);
  searchInput.addEventListener('input', renderTable);
  scanInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      manejarScan(scanInput.value);
      scanInput.value = '';
    }
  });

  window.addEventListener('load', () => {
    sincronizarSesion().finally(() => {
      if (sessionInfo) scanInput.focus();
    });
  });
</script>

</body>
</html>
